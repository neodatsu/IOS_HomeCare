name: Nightly Build

on:
  schedule:
    # Tous les jours Ã  2h UTC (3h Paris en hiver, 4h en Ã©tÃ©)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_performance_tests:
        description: 'Run performance tests'
        required: false
        type: boolean
        default: true

env:
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer
  XCODE_VERSION: '26.2'
  IOS_VERSION: '26.0'
  DEVICE: 'iPhone 17 Pro'

jobs:
  nightly-build:
    name: Nightly Build & Test
    runs-on: macos-15
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Select Xcode version
      run: |
        sudo xcode-select -switch $DEVELOPER_DIR
        xcodebuild -version
        swift --version

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-nightly-derived-data-${{ hashFiles('**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-nightly-derived-data-
          ${{ runner.os }}-derived-data-

    - name: Install dependencies
      run: |
        brew install swiftlint

    - name: Clean build folder
      run: |
        xcodebuild clean \
          -project HomeCare/HomeCare.xcodeproj \
          -scheme HomeCare

    - name: Build project
      run: |
        xcodebuild build \
          -project HomeCare/HomeCare.xcodeproj \
          -scheme HomeCare \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee build.log

    - name: Run all tests
      run: |
        xcodebuild test \
          -project HomeCare/HomeCare.xcodeproj \
          -scheme HomeCare \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          -enableCodeCoverage YES \
          -parallel-testing-enabled YES \
          -maximum-parallel-testing-workers 4 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee test.log

    - name: Run SwiftLint
      run: |
        cd HomeCare
        swiftlint lint --reporter html > ../swiftlint-report.html
        swiftlint lint --reporter github-actions-logging
      continue-on-error: true

    - name: Performance tests
      if: ${{ github.event.inputs.run_performance_tests != 'false' }}
      run: |
        echo "âš¡ Running performance tests..."
        
        build_time=$(grep "BUILD SUCCEEDED" build.log | tail -1 || echo "N/A")
        echo "Build time: $build_time"
        
        test_time=$(grep "Test Suite 'All tests' passed" test.log | tail -1 || echo "N/A")
        echo "Test time: $test_time"
        
        echo "## Performance Metrics" > performance-report.md
        echo "- Build time: $build_time" >> performance-report.md
        echo "- Test time: $test_time" >> performance-report.md
        echo "- Date: $(date)" >> performance-report.md

    - name: Memory leak detection
      run: |
        echo "ðŸ” Checking for memory leaks..."
        
        retain_cycles=$(grep -r "\[weak self\]\|\[unowned self\]" HomeCare/HomeCare --include="*.swift" | wc -l || echo "0")
        strong_refs=$(grep -r "{ self\." HomeCare/HomeCare --include="*.swift" | \
          grep -v "\[weak self\]" | \
          grep -v "\[unowned self\]" | wc -l || echo "0")
        
        echo "Found $retain_cycles weak/unowned references"
        echo "Found $strong_refs potential strong reference captures"
        
        echo "## Memory Analysis" > memory-report.md
        echo "- Weak/Unowned refs: $retain_cycles" >> memory-report.md
        echo "- Potential strong captures: $strong_refs" >> memory-report.md
        
        if [ "$strong_refs" -gt 50 ]; then
          echo "::warning::High number of potential strong reference captures detected"
        fi

    - name: Code coverage report
      run: |
        echo "ðŸ“Š Generating code coverage report..."
        
        xcrun llvm-cov export \
          -format="lcov" \
          -instr-profile $(find ~/Library/Developer/Xcode/DerivedData -name "*.profdata" | head -n 1) \
          $(find ~/Library/Developer/Xcode/DerivedData -name "HomeCare" -type f | head -n 1) \
          > coverage.lcov || echo "Coverage generation skipped"
        
        if [ -f coverage.lcov ]; then
          echo "âœ… Coverage report generated"
        else
          echo "âš ï¸ Coverage report not available"
        fi

    - name: Security scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'HomeCare'
        format: 'table'
      continue-on-error: true

    - name: Generate build report
      if: always()
      run: |
        echo "# Nightly Build Report" > nightly-report.md
        echo "" >> nightly-report.md
        echo "**Date:** $(date)" >> nightly-report.md
        echo "**Xcode:** ${{ env.XCODE_VERSION }}" >> nightly-report.md
        echo "**iOS:** ${{ env.IOS_VERSION }}" >> nightly-report.md
        echo "**Device:** ${{ env.DEVICE }}" >> nightly-report.md
        echo "" >> nightly-report.md
        
        echo "## Build Status" >> nightly-report.md
        if [ -f build.log ] && grep -q "BUILD SUCCEEDED" build.log; then
          echo "- âœ… Build: Success" >> nightly-report.md
        else
          echo "- âŒ Build: Failed" >> nightly-report.md
        fi
        
        if [ -f test.log ] && grep -q "Test Suite 'All tests' passed" test.log; then
          echo "- âœ… Tests: Success" >> nightly-report.md
        else
          echo "- âŒ Tests: Failed" >> nightly-report.md
        fi
        
        cat nightly-report.md

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-reports
        path: |
          build.log
          test.log
          swiftlint-report.html
          performance-report.md
          memory-report.md
          nightly-report.md
          coverage.lcov
        retention-days: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: success()
      with:
        files: ./coverage.lcov
        flags: nightly
        name: nightly-coverage
      continue-on-error: true

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Nightly build failed!"
        echo "Check the artifacts and logs for details."
        
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âŒ HomeCare iOS - Nightly build failed! Check GitHub Actions for details."}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "Slack notification failed"
        fi

    - name: Summary
      if: always()
      run: |
        echo "## ðŸŒ™ Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Xcode:** ${{ env.XCODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **iOS:** ${{ env.IOS_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Device:** ${{ env.DEVICE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f nightly-report.md ]; then
          cat nightly-report.md >> $GITHUB_STEP_SUMMARY
        fi
